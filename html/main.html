<!doctype html>
<html>
    <head>
        <title>{{applicationName}}</title>
        <script type="application/json" data-name="loader-params">{{loaderParams}}</script>{{scriptsHtml}}
        <link rel="stylesheet" href="{{basePath}}{{stylesheet}}?r={{cacheTimestamp}}" id='main-stylesheet'>{{additionalStyleSheetsHtml}}{{linksHtml}}
        <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
        <meta content="utf-8" http-equiv="encoding">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <meta name="description" content="{{applicationDescription}}">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="alternate icon" href="{{basePath}}{{faviconAlternate}}" type="image/x-icon">
        <link rel="icon" href="{{basePath}}{{favicon}}" type="{{faviconType}}">
        <script nonce="{{nonce}}">
            // Autocrm Find Contacts functionality
            (function() {
                
                function addFindContactsMenuItem() {
                    
                    // Look specifically for the Lead record action dropdown (next to Edit button)
                    // Exclude top-right menu dropdown and other system dropdowns
                    var dropdownMenu = document.querySelector('.dropdown-menu:not([aria-labelledby*="menu-dropdown"]):not([aria-labelledby*="quick-create"]):not([aria-labelledby*="tabs"]):not([aria-labelledby*="more-tabs"])');
                    
                    if (dropdownMenu && !document.querySelector('.autocrm-find-contacts-item')) {
                        console.log('Autocrm: Found correct dropdown menu:', dropdownMenu);
                        console.log('Autocrm: Dropdown classes:', dropdownMenu.className);
                        console.log('Autocrm: Dropdown aria-labelledby:', dropdownMenu.getAttribute('aria-labelledby'));
                        // Create menu item
                        var menuItem = document.createElement('li');
                        menuItem.className = 'autocrm-find-contacts-item';
                        
                        var link = document.createElement('a');
                        link.href = '#';
                        link.innerHTML = 'Find Contacts';
                        link.style.cursor = 'pointer';
                        
                        link.onclick = function(e) {
                            e.preventDefault();
                            console.log('Autocrm: Find Contacts clicked from dropdown');
                            
                            var url = window.location.href;
                            var leadIdMatch = url.match(/\/#Lead\/view\/([a-f0-9]+)/);
                            
                            if (!leadIdMatch) {
                                alert('No lead ID found in URL');
                                return;
                            }
                            
                            var leadId = leadIdMatch[1];
                            //alert('Searching for contacts...');
                            
                            var xhr = new XMLHttpRequest();
                            xhr.open('POST', '/espo/api/v1/Lead/action/findContacts', true);
                            xhr.setRequestHeader('Content-Type', 'application/json');
                            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                            
                            xhr.onreadystatechange = function() {
                                if (xhr.readyState === 4 && xhr.status === 200) {
                                    try {
                                        var response = JSON.parse(xhr.responseText);
                                        if (response.success) {
                                            var contacts = response.contacts || [];
                                            var emailAddress = response.emailAddress;
                                            
                                            if (contacts.length === 0) {
                                                alert('No contacts found with the same email address: ' + (emailAddress || 'N/A'));
                                            } else {
                                                var message = 'Found ' + contacts.length + ' contact(s) with email address: ' + emailAddress + '\n\n';
                                                contacts.forEach(function(contact) {
                                                    message += '• ' + contact.firstName + ' ' + contact.lastName + ' (' + contact.emailAddress + ')\n';
                                                });
                                                alert(message);
                                            }
                                        }
                                    } catch (e) {
                                        alert('Error: ' + e.message);
                                    }
                                }
                            };
                            
                            xhr.send(JSON.stringify({id: leadId}));
                        };
                        
                        menuItem.appendChild(link);
                        dropdownMenu.appendChild(menuItem);
                        console.log('Autocrm: Find Contacts menu item added to dropdown');
                    } else if (!dropdownMenu) {
                        console.log('Autocrm: Dropdown menu not found, trying alternative approach');
                        
                        // Try to find the dropdown button and add item when clicked
                        var dropdownButton = document.querySelector('.dropdown-menu-button, .btn-group .dropdown-toggle, [data-action="dropdown"]');
                        console.log('Autocrm: Dropdown button found:', dropdownButton);
                        
                        if (dropdownButton) {
                            dropdownButton.addEventListener('click', function() {
                                console.log('Autocrm: Dropdown button clicked');
                                setTimeout(function() {
                                    // Look for the correct dropdown (next to Edit button, not top-right menu)
                                    var menu = document.querySelector('.dropdown-menu:not([aria-labelledby*="menu-dropdown"]):not([aria-labelledby*="quick-create"]):not([aria-labelledby*="tabs"]):not([aria-labelledby*="more-tabs"])');
                                    console.log('Autocrm: Menu after click:', menu);
                                    if (menu) {
                                        console.log('Autocrm: Menu classes:', menu.className);
                                        console.log('Autocrm: Menu aria-labelledby:', menu.getAttribute('aria-labelledby'));
                                    }
                                    
                                    if (menu && !document.querySelector('.autocrm-find-contacts-item')) {
                                        var menuItem = document.createElement('li');
                                        menuItem.className = 'autocrm-find-contacts-item';
                                        
                                        var link = document.createElement('a');
                                        link.href = '#';
                                        link.innerHTML = 'Find Contacts';
                                        link.style.cursor = 'pointer';
                                        
                                        link.onclick = function(e) {
                                            e.preventDefault();
                                            console.log('Autocrm: Find Contacts clicked from dropdown');
                                            
                                            var url = window.location.href;
                                            var leadIdMatch = url.match(/\/#Lead\/view\/([a-f0-9]+)/);
                                            
                                            if (!leadIdMatch) {
                                                alert('No lead ID found in URL');
                                                return;
                                            }
                                            
                                            var leadId = leadIdMatch[1];
                                            //alert('Searching for contacts...');
                                            
                                            var xhr = new XMLHttpRequest();
                                            xhr.open('POST', '/espo/api/v1/Lead/action/findContacts', true);
                                            xhr.setRequestHeader('Content-Type', 'application/json');
                                            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                                            
                                            xhr.onreadystatechange = function() {
                                                if (xhr.readyState === 4 && xhr.status === 200) {
                                                    try {
                                                        var response = JSON.parse(xhr.responseText);
                                                        if (response.success) {
                                                            var contacts = response.contacts || [];
                                                            var emailAddress = response.emailAddress;
                                                            
                                                            if (contacts.length === 0) {
                                                                alert('No contacts found with the same email address: ' + (emailAddress || 'N/A'));
                                                            } else {
                                                                var message = 'Found ' + contacts.length + ' contact(s) with email address: ' + emailAddress + '\n\n';
                                                                contacts.forEach(function(contact) {
                                                                    message += '• ' + contact.firstName + ' ' + contact.lastName + ' (' + contact.emailAddress + ')\n';
                                                                });
                                                                alert(message);
                                                            }
                                                        }
                                                    } catch (e) {
                                                        alert('Error: ' + e.message);
                                                    }
                                                }
                                            };
                                            
                                            xhr.send(JSON.stringify({id: leadId}));
                                        };
                                        
                                        menuItem.appendChild(link);
                                        menu.appendChild(menuItem);
                                        console.log('Autocrm: Find Contacts menu item added to dropdown');
                                    }
                                }, 100);
                            });
                        }
                    }
                }
                
                function init() {
                    setTimeout(addFindContactsMenuItem, 1000);
                    
                    var observer = new MutationObserver(function(mutations) {
                        mutations.forEach(function(mutation) {
                            if (mutation.type === 'childList') {
                                setTimeout(addFindContactsMenuItem, 500);
                            }
                        });
                    });
                    
                    observer.observe(document.body, {
                        childList: true,
                        subtree: true
                    });
                }
                
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', init);
                } else {
                    init();
                }
            })();
            
            let loadedApp;

            const run = app => {
                {{runScript}}
            };

            const init = () => {
                require('{{appClientClassName}}', App => {
                    new App({
                        id: '{{applicationId}}',
                        useCache: {{useCache}},
                    cacheTimestamp: {{cacheTimestamp}},
                    appTimestamp: {{appTimestamp}},
                    basePath: '{{basePath}}',
                    apiUrl: '{{apiUrl}}',
                    ajaxTimeout: {{ajaxTimeout}},
                    internalModuleList: {{internalModuleList}},
                    bundledModuleList: {{bundledModuleList}},
                    theme: {{theme}},
                }, app => {
                        loadedApp = app;

                        run(app);
                    });
                });
            };

            window.addEventListener('pageshow', event => {
                if (event.persisted && loadedApp) {
                    run(loadedApp);

                    return;
                }

                init();
            });
        </script>
    </head>
    <body data-id="{{applicationId}}">
        <div class="container content"></div>
        <footer>
            <p class="credit small">&copy; 2025
            <a href="https://www.espocrm.com" title="Powered by EspoCRM" rel="noopener" target="_blank">EspoCRM, Inc.</a></p>
        </footer>
    </body>
</html>
